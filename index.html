<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Map Flores Timur</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <!-- Leaflet Fullscreen Plugin CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.0.2/Control.FullScreen.css" 
        integrity="sha512-n1cQz3Q7EB20NOmd3IuUjBcbEkyU1zR1p/m5g4adMp9a2r1/1TnvcAq4IEbeEsqmH3s49EVb9I4648AZjS+HQw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Leaflet Search Plugin CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.2/dist/leaflet-search.src.css" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

    <!-- Leaflet Fullscreen Plugin JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/1.0.2/Control.FullScreen.js" 
        integrity="sha512-i1AYJ1I83T03A2Mv7Ju1TN11I2Hl4s4jDVMR2yS9j2XyvQx+8+9t4CHDTm9n28H/KMA5M1R1Qk6Tj1Jsnjngw==" 
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Leaflet Search Plugin JS -->
    <script src="https://unpkg.com/leaflet-search@3.0.2/dist/leaflet-search.src.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1; /* Map fills remaining vertical space */
            width: 100%;
        }
        .legend {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend h4 {
            margin: 10px 0 5px;
            font-size: 14px;
            text-align: center;
        }
        .legend .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            margin-right: 8px;
            opacity: 0.9;
        }
        .road-legend-line {
            width: 20px;
            height: 10px;
            display: inline-block;
            margin-right: 8px;
            position: relative;
        }

        /* Aturan untuk layar kecil (smartphone) */
        @media (max-width: 767px) {
            .legend {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Flores Timur</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map"></div>

    <!-- Kecamatan Info Modal -->
    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">Detail Kecamatan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="infoModalBody">
                    <!-- Konten modal akan diisi oleh JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About This Map</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Nama:</strong>  Ratih Esti Mutiarahati</p>
                    <p><strong>NIM:</strong>  24/535893/SV/24327</p>
                    <p><strong>Kelas:</strong>  B</p>
                    <hr>
                    <div class="text-center">
                        <p class="mb-0">Pemrograman Geospasial: Web</p>
                        <p class="mb-0">Acara 6</p>
                        <p class="mb-0">LEAFLET BOOTSTRAP</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // 1. Inisialisasi Peta
        var map = L.map('map', {
            fullscreenControl: true,
        }).setView([-8.45, 122.9], 10);

        // Inisialisasi Modal Bootstrap
        var infoModal = new bootstrap.Modal(document.getElementById('infoModal'));

        // 2. Membuat Pane untuk Kontrol Urutan Layer
        map.createPane('batasKecamatanPane');
        map.getPane('batasKecamatanPane').style.zIndex = 410;
        map.createPane('sungaiPane');
        map.getPane('sungaiPane').style.zIndex = 420;
        map.createPane('jalanPane');
        map.getPane('jalanPane').style.zIndex = 430;

        // 3. Menambahkan Basemap
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });

        var esriSatelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        osm.addTo(map);
        var baseMaps = {
            "OpenStreetMap": osm,
            "Esri Satelit": esriSatelit
        };

        // 4. Logika untuk Simbologi dan Legenda
        function getColorPenduduk(p) {
            return p > 30000 ? '#8c510a' : p > 15000 ? '#bf812d' : '#f6e8c3';
        }

        function styleKecamatan(feature) {
            return {
                fillColor: getColorPenduduk(feature.properties.Penduduk),
                weight: 1.5,
                opacity: 1,
                color: 'black',
                fillOpacity: 0.8
            };
        }

        function getRoadWeight(namaUnsur) {
            switch (namaUnsur) {
                case 'Jalan Provinsi': return 4;
                case 'Jalan Kabupaten': return 2.5;
                case 'Jalan Lain': return 1.5;
                default: return 1;
            }
        }

        function styleJalan(feature) {
            return {
                color: '#FF0000',
                weight: getRoadWeight(feature.properties.NAMA_UNSUR)
            };
        }

        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<h4>Jumlah Penduduk</h4>';
            var grades = [0, 15000, 30000];
            for (var i = 0; i < grades.length; i++) {
                var from = grades[i];
                var to = grades[i + 1];
                var labelText = new Intl.NumberFormat('id-ID').format(from) + (to ? ' &ndash; ' + new Intl.NumberFormat('id-ID').format(to) : '+');
                div.innerHTML +=
                    '<div class="legend-item">' +
                        '<i style="background:' + getColorPenduduk(from + 1) + '"></i>' +
                        '<span>' + labelText + '</span>' +
                    '</div>';
            }
            div.innerHTML += '<h4 style="margin-top: 10px;">Infrastruktur</h4>';
            var roadTypes = {
                'Jalan Provinsi': 4,
                'Jalan Kabupaten': 2.5,
                'Jalan Lain': 1.5
            };
            for (var key in roadTypes) {
                div.innerHTML +=
                    '<div class="legend-item">' +
                    '<span class="road-legend-line" style="border-bottom: ' + roadTypes[key] + 'px solid #FF0000;"></span>' +
                    '<span>' + key + '</span>' +
                    '</div>';
            }
            div.innerHTML +=
                '<div class="legend-item">' +
                '<span class="road-legend-line" style="border-bottom: 1.5px solid #0055ff;"></span>' +
                '<span>Sungai</span>' +
                '</div>';
            return div;
        };
        legend.addTo(map);

        // 5. Memuat Layer GeoJSON
        var overlayMaps = {};
        var layersLoaded = 0;
        var layerControl;

        function onLayerLoaded() {
            layersLoaded++;
            if (layersLoaded === 5) {
                var isCollapsed = window.innerWidth < 768;
                layerControl = L.control.layers(baseMaps, overlayMaps, { collapsed: isCollapsed }).addTo(map);
            }
        }

        function loadGeoJSON(url, layerName, options) {
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    var geoJsonLayer = L.geoJSON(data, options);
                    overlayMaps[layerName] = geoJsonLayer;
                    if (layerName !== 'Batas Desa') {
                        geoJsonLayer.addTo(map);
                    }
                    onLayerLoaded();
                    return geoJsonLayer;
                })
                .catch(error => {
                    console.error('Error loading GeoJSON: ', error);
                    onLayerLoaded();
                });
        }

        loadGeoJSON('data/batas_desa.geojson', 'Batas Desa', { style: { color: '#7a7a7a', weight: 1, dashArray: '4, 4' } });
        loadGeoJSON('data/jalan.geojson', 'Jalan', { style: styleJalan, pane: 'jalanPane' });
        loadGeoJSON('data/sungai.geojson', 'Sungai', { style: { color: '#0055ff', weight: 1.5 }, pane: 'sungaiPane' });
        loadGeoJSON('data/toponimi.geojson', 'Toponimi (Nama Lokasi)', {
            pointToLayer: (feature, latlng) => L.marker(latlng),
            onEachFeature: (feature, layer) => { if (feature.properties && feature.properties.NAMOBJ) { layer.bindPopup(feature.properties.NAMOBJ); } }
        });

        fetch('data/batas_kecamatan.geojson')
            .then(response => response.json())
            .then(data => {
                var batasKecamatanLayer = L.geoJSON(data, {
                    style: styleKecamatan,
                    pane: 'batasKecamatanPane',
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function (e) {
                            if (feature.properties && feature.properties.WADMKC && feature.properties.Penduduk) {
                                document.getElementById('infoModalLabel').textContent = 'Kecamatan ' + feature.properties.WADMKC;
                                document.getElementById('infoModalBody').innerHTML = '<p><strong>Jumlah Penduduk:</strong> ' + new Intl.NumberFormat('id-ID').format(feature.properties.Penduduk) + ' jiwa</p>';
                                infoModal.show();
                            }
                        });
                        if (feature.properties && feature.properties.WADMKC) {
                            layer.bindTooltip(feature.properties.WADMKC, { sticky: true });
                        }
                    }
                });

                overlayMaps['Penduduk per Kecamatan'] = batasKecamatanLayer;
                batasKecamatanLayer.addTo(map);
                onLayerLoaded();

                var searchControl = new L.Control.Search({
                    layer: batasKecamatanLayer,
                    propertyName: 'WADMKC',
                    initial: false,
                    zoom: 13,
                    marker: false,
                    textPlaceholder: 'Cari Kecamatan...'
                });

                searchControl.on('search:locationfound', function(e) {
                    e.layer.setStyle({fillColor: '#3f0', color: '#0f0'});
                }).on('search:collapsed', function(e) {
                    batasKecamatanLayer.eachLayer(function(layer) {
                        batasKecamatanLayer.resetStyle(layer);
                    });
                });

                map.addControl(searchControl);
            })
            .catch(error => {
                console.error('Error loading GeoJSON for search: ', error);
                onLayerLoaded();
            });

        setTimeout(function() {
            map.invalidateSize();
        }, 100);

    </script>
</body>
</html>